
inputs:
  image_tag:
    type: string
    required: true
  lock-repository:
    type: string
  lock-id:
    type: string
  lock-token:
    type: string
  lock-app-id:
    type: string
  lock-app-key:
    type: string

outputs:
  cached:
    value: ${{ steps.prime.outputs.cached }}


runs:
  using: "composite"
  steps:
  - uses: envoyproxy/toolshed/gh-actions/appauth@e0ddd63d2326ec5f0d2acd8807a36e3b1eaa7d27
    if: ${{ inputs.lock-app-id && inputs.lock-app-key }}
    name: Fetch app auth
    id: appauth
    with:
      app_id: ${{ inputs.lock-app-id }}
      key: ${{ inputs.lock-app-key }}
  - uses: envoyproxy/toolshed/gh-actions/github/mutex@e0ddd63d2326ec5f0d2acd8807a36e3b1eaa7d27
    if: ${{ steps.appauth.outputs.token || inputs.lock-token }}
    with:
      key: ${{ inputs.lock-id || inputs.image_tag }}
      repository: ${{ inputs.lock-repository }}
      token: ${{ steps.appauth.outputs.token || inputs.lock-token }}
  - uses: envoyproxy/toolshed/gh-actions/cache/prime@e0ddd63d2326ec5f0d2acd8807a36e3b1eaa7d27
    id: prime
    with:
      key: "${{ inputs.image_tag }}"
      command: |
        systemctl stop docker docker.socket
        mv /var/lib/docker /var/lib/docker.orig
        mkdir /var/lib/docker
        systemctl start docker
        docker pull ${{ inputs.image_tag }}
        systemctl stop docker
        tar cf - -C /var/lib/docker . | zstd - -T0 -o docker.tar.zst
